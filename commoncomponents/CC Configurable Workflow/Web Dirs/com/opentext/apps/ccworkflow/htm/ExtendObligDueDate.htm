<!DOCTYPE html>
<html>

<head>
    <title>Extend obligation due date</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../../../../../com/opentext/apps/utils/css/appscommon.css">
    <link rel="stylesheet" href="../../../../../thirdparty/bootstrap/css/bootstrap.min.css">
    <script src="../../../../../thirdparty/jquery/jquery.js" type="text/javascript"></script>
    <script src="../../../../../html5/cordys.html5sdk.js" type="text/javascript"></script>
    <script src="../../../../../html5/thirdparty/moment.js" type="text/javascript"></script>
    <script src="../../../../../thirdparty/knockout/knockout.js" type="text/javascript"></script>
    <script src="../../../../../thirdparty/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../../../../../com/opentext/apps/utils/js/appscommon.js" type="text/javascript"></script>
    <script src="../../../../../com/opentext/apps/utils/js/translationsUtil.js" type="text/javascript"></script>
    <link rel="stylesheet" href="../../../../../app/start/web/thirdpartylibs/jquery-datepicker/jquery-ui.min.css" />
    <script src="../../../../../app/start/web/thirdpartylibs/jquery-datepicker/jquery-ui.min.js"
        type="text/javascript"></script>
    <script type="text/javascript">
        $.cordys.json.defaults.removeNamespacePrefix = true;
        var l_instanceID = "";

        var DuedateModel = function () {
            var self = this;
            self.dueDate = ko.observable('');
            self.dueDatetoLocale = ko.observable('');
            self.deadlineDueDate = ko.observable('');

            self.bindJqueryFunc = function () {
                var format = "yy-mm-dd";
                $("#input_dueDate").datepicker({
                    dateFormat: format,
                    orientation: "top",
                    onSelect: function (dateText, inst) {
                        self.dueDate(dateText);
                        self.dueDatetoLocale(formateDatetoLocale(dateText));
                        var l_dueDate = new Date(l_dueDate_model.dueDate())
                        if (l_dueDate > new Date(new Date().toISOString().split('T')[0])) {
                            l_dueDate.setHours(23,57,0,0);
                            self.deadlineDueDate(l_dueDate.toISOString());
                            $('ai-dialog-footer .btn-primary:contains("Update")', window.parent.parent.document).attr("disabled", false);
                        } else {
                            $('ai-dialog-footer .btn-primary:contains("Update")', window.parent.parent.document).attr("disabled", true);
                            showOrHideErrorInfo("div_formErrorInfoArea", true, getTranslationMessage("Invalid date: Enter a date greater than the present date."), 10000);
                            return false;
                        }
                    }
                });
            };
        }

        $(function () {
            var i_locale = getlocale();
            var rtl_css = '../../../../../../com/opentext/apps/utils/css/rtlappscommon.css';
            translateLabels("com/opentext/apps/commoncomponents/CCConfigurableWorkflow/CCConfigurableWorkflow", i_locale);
            loadRTLIfRequired(i_locale, rtl_css);

            l_GCinstanceID = getUrlParameterValue("GCInsID", null, true);

            //Platform dialog enhancements
            platformDialogModifications("Update", UpdateDuedate);
            $('ai-dialog-footer .btn-primary:contains("Update")', window.parent.parent.document).attr("disabled", true);

            l_dueDate_model = new DuedateModel();
            ko.applyBindings(l_dueDate_model, document.getElementById("div_updateDuedate"));

            setTimeout(function () {
                l_dueDate_model.bindJqueryFunc();
            }, 0);
            ReadTaskDueDate();
        });

        function platformDialogModifications(i_newButtonName, i_newButtonAction) {
            $('ai-dialog', window.parent.parent.document).animate({
                'max-height': '60vh',
                'max-width': '40vw',
                'width': '40vw',
                'height': '60vh'
            }, 500);

            //Dialog content style enhancements				
            $('ai-dialog-body iframe', window.parent.parent.document).css({
                'width': '100%',
                'height': 'calc(100% - 6px)'
            });

            $('ai-dialog-body', window.parent.parent.document).css({
                'max-height': 'calc(60vh - 103px)',
                'height': '45vh',
            });

            $('.layout-panel .panel-container', window.parent.document).css({
                'padding-left': '0px'
            });

            $('panel-container iframe', window.parent.document).css({
                'height': 'calc(100% - 6px)',
                'width': '100%',
                'border': '0px'
            });
            //hide OK button
            $('ai-dialog-footer .btn-primary:contains("OK")', window.parent.parent.document).hide();
            //Save changes action in footer
            var newBtn = document.createElement("Button");
            newBtn.innerHTML = i_newButtonName;
            newBtn.className = "btn btn-primary";
            newBtn.onclick = i_newButtonAction;
            $('ai-dialog-footer .btn-primary', window.parent.parent.document).before(newBtn);
        }

        function ReadTaskDueDate() {
            $.cordys.ajax({
                namespace: "http://schemas.opentext.com/apps/cc/configworkflow/20.2",
                method: "ReadGCActInstance",
                parameters: {
                    "gcActInstID": l_GCinstanceID
                },
                success: function (data) {
                    if (data.OutputMessage.FindZ_INT_GCActivityInstancesResponse.GCActivityInstances.Duedate) {
                        var l_escDueDate = getTextValue(data.OutputMessage.FindZ_INT_GCActivityInstancesResponse.GCActivityInstances.Duedate).replace('Z', '');
                        l_dueDate_model.dueDate(l_escDueDate);
                        l_dueDate_model.dueDatetoLocale(formateDatetoLocale(l_escDueDate));
                    }
                },
                error: function (responseFailure) {
                    showOrHideErrorInfo("div_formErrorInfoArea", true, getTranslationMessage("An error occurred while fetching due date. Contact the administrator."), 10000);
                    return false;
                }
            });
        }

        function UpdateDuedate() {
            $.cordys.ajax({
                namespace: "http://schemas/OpenTextCCConfigurableWorkflow/GCActivityInstances/operations",
                method: "UpdateGCActivityInstances",
                parameters: {
                    "GCActivityInstances-id":
                    {
                        "Id": l_GCinstanceID
                    },
                    "GCActivityInstances-update":
                    {
                        "Duedate": l_dueDate_model.dueDate(),
                        "Deadlines-update":
                        {
                            "Escalation_DueDate": l_dueDate_model.deadlineDueDate()
                        }
                    }
                },
                success: function (data) {
                    $('#div_updateDuedate').css('display', 'none');
                    $('#div_updateSuccessMessg').css('display', 'block');
                    $('ai-dialog-footer .btn-primary:contains("Update")', window.parent.parent.document).hide()
                    $('ai-dialog-footer .btn:contains("Cancel")', window.parent.parent.document).text("Close");
                },
                error: function (responseFailure) {
                    showOrHideErrorInfo("div_formErrorInfoArea", true, getTranslationMessage("An error occurred while updating due date. Contact the administrator."), 10000);
                    return false;
                }
            });
        }
    </script>
</head>

<body class="cc-ltr">
    <div id="div_updateSuccessMessg" class="col-xs-12 cc-info-message" style="display: none;">
        <span data-translatable="true">Due date for the task is extended.</span>
    </div>
    <div class="cc-error-info-area" id="div_formErrorInfoArea">
        <img src="../../../../../com/opentext/apps/utils/img/notification_error.svg"
            style="width: 11px; height: 11px;" />
        <span id="span_errorInfoMessage" style="position: relative;"></span>
    </div>
    <div id="div_updateDuedate" style="padding-top: 30px;">
        <div class="col-md-12 no-padding">
            <div class="form-group col-md-5 rtl-float-right">
                <label class="cc-required" data-translatable="true">Due date</label>
                <div>
                    <input type="text" class="form-control dropdown-select-calender" id="input_dueDate" autocomplete="off"
                        data-bind="value:dueDatetoLocale" data-translatable="true">
                </div>
            </div>
        </div>
    </div>
</body>

</html>