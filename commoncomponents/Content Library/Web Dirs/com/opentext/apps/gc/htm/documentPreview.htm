<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="../../../../../thirdparty/bootstrap/css/bootstrap.min.css">
	</link>
	<link rel="stylesheet" href="../css/appscommon.css" />
	<script src="../../../../../thirdparty/jquery/jquery.js" type="text/javascript"></script>
	<script src="../../../../../html5/cordys.html5sdk.js" type="text/javascript"></script>
	<script src="../../../../../html5/thirdparty/moment.js" type="text/javascript"></script>
	<script src="../../../../../thirdparty/knockout/knockout.js" type="text/javascript"></script>
	<script src="../../../../../thirdparty/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
	<script src="../../../../../com/opentext/apps/utils/js/appscommon.js" type="text/javascript"></script>
	<script src="../../../../../com/opentext/apps/utils/js/translationsUtil.js" type="text/javascript"></script>
	<style>
		.cc-frame-area {
			height: 100vh;
			padding: 0;
			border-left: 1px solid #efefef;
		}

		body {
			overflow-y: hidden;
		}

		.cc-frame {
			height: 100%;
			width: 100%;
			border: 0;
		}

		#cc-doc-preview-loadmsg {
			position: absolute;
			left: 50%;
			top: 50%;
			transform: translate(-50%, -50%);
		}

		#_Cordys_Ajax_LoadingIndicator {
			left: auto !important;
			top: 30% !important;
			right: 45% !important;
		}
	</style>
	<script type="text/javascript">
		var l_ExceptionMsg = "An error occurred while generating the template document. Contact the administrator.";
		var g_parentWindow = window.parent.parent;
		var INSTANCEID, BASEURL;

		// On document ready
		$(function () {
			$.cordys.json.defaults.removeNamespacePrefix = true;
			var i_locale = getlocale();
			var rtl_css = '../../../../../com/opentext/apps/utils/css/rtlappscommon.css';
			translateLabels("com/opentext/apps/commoncomponents/ContentLibrary/ContentLibrary", i_locale, true);
			loadRTLIfRequired(i_locale, rtl_css);
			$('.ui-dialog', window.parent.parent.document).fadeIn();

			//Fetching URL parameters
			INSTANCEID = getUrlParameterValue("instanceId", null, true);
			BASEURL = getUrlParameterValue("baseURL", null, true);

			//Platform dialog enhancements
			platformDialogModifications("Save document");
			createDocPreviewInstanceIfNotCreated();
			document.getElementById("cc-doc-preview-frame").onload = removeBackground();
		});
		
		function translatePlaceHolders(){
            var elems = window.parent.parent.document.getElementsByClassName("btn-translate");
            if(elems)
                for(var ind = 0; ind < elems.length; ind++){
                    elems[ind].innerHTML = getTranslationMessage(elems[ind].innerHTML);
                    elems[ind].title = elems[ind].innerHTML;
                }
        }

		function platformDialogModifications(okBtnName) {
			//Changing OK to new name
			//$('ai-dialog-footer .btn-primary:contains("OK")', window.parent.parent.document).text(okBtnName);
			
			var OkElem = getOKButton();
			if(OkElem){
				OkElem.innerHTML = okBtnName;
				OkElem.setAttribute("class", OkElem.className + " btn-translate");

			}
			window.addStylesToPlatformLayout(frameElement.ownerDocument);
			

			// $('.btn-ok', window.parent.document).addClass('btn-primary');

			$('ai-dialog', window.parent.parent.document).animate({
				'max-height': '80vh',
				'max-width': '80vw',
				'width': '80vw',
				'height': '80vh'
			}, 500);

			//Dialog content style enhancements				
			$('ai-dialog-body iframe', window.parent.parent.document).css({
				'width': '100%',
				'height': 'calc(100% - 6px)'
			});

			$('ai-dialog-body', window.parent.parent.document).css({
				'max-height': 'calc(80vh - 103px)',
				'height': '75vh',
			});

			$('.layout-panel .panel-container', window.parent.document).css({
				'padding-left': '0px'
			});

			$('panel-container iframe', window.parent.document).css({
				'height': 'calc(100% - 6px)',
				'width': '100%',
				'border': '0px'
			});
		}

		function reloadPreview() {
			var frameElem = $('#cc-doc-preview-frame');
			var srcFrame = frameElem.attr('src');
			frameElem.attr('src', srcFrame);
		}

		function loadPreview() {
			$.cordys.ajax({
				method: "GenerateTemplateDocument",
				namespace: "http://schemas.opentext.com/apps/contentlibrary/19.2",
				parameters: {
					"ItemId": INSTANCEID
				},
				success: function (responseSuccess) {
					if (responseSuccess.PreviewItemId) {
						var prevItemId = getTextValue(responseSuccess.PreviewItemId);
						var bravaURL = buildBravaPreviewURL(BASEURL, prevItemId);
						$('#cc-doc-preview-loadmsg').hide();
						$('#cc-doc-preview-frame').attr('src', bravaURL);

					} else {
						window.showOrHideInfo(true, responseSuccess, "Error", 10000);
					}
				},
				error: function (responseFailure) {
					window.showOrHideInfo(true, responseFailure, "Error", 10000);
					return false;
				}
			});
		}

		function createDocPreviewInstanceIfNotCreated(){
            $.cordys.ajax({
                method: "CreateTemplateDocPreview",
                namespace: "http://schemas.opentext.com/apps/contentlibrary/19.2",
                parameters: {
                    "TemplateItemID": INSTANCEID
                },
                success: function (responseSuccess) {
                    if (responseSuccess) {
                        loadPreview();
                    } else {
                        window.showOrHideInfo(true, responseSuccess, "Error", 10000);
                    }
                },
                error: function (responseFailure) {
                    window.showOrHideInfo(true, responseFailure, "Error", 10000);
                    return false;
                }
            });
        }

		function buildBravaPreviewURL(BASEURL, PREVITEMID) {
			return BASEURL + "app/start/web/perform/item/" + PREVITEMID + "/3C6AA73A0114A1EBA85437604E3966ED";
		}

		function removeBackground() {
			return function () {
				var frameElem = $('#cc-doc-preview-frame')[0];
				if (frameElem) {
					window.addStylesToPlatformLayout(frameElem.contentWindow.document);
				}
			}
		}

		function addStylesToPlatformLayout(iDocument) {
			var l_Style = iDocument.createElement("style");
			l_Style.innerHTML = ".root-container {background: none !important;} \n .layout-panel {border: none !important;}";
			iDocument.head.appendChild(l_Style);
		}

		$(window).on("unload", function(e) {
			g_parentWindow.location.reload();
		});

		function showOrHideInfo(iShow, iResponse, iType, iVisibleTime) {

			var l_infoArea = document.getElementById("InfoArea");

			if (iShow) {
				var fault = iResponse.responseJSON;
				var iMessage = null;
				var _FaultCode = null;

				if (fault != undefined) {
					_FaultCode = fault.faultcode.hasOwnProperty('text') ? fault.faultcode.text : fault.faultcode;
					iMessage = _FaultCode.includes('DocGen') ? getTranslationMessage(fault.faultstring.text) : getTranslationMessage(l_ExceptionMsg);
				} else {
					iMessage = getTranslationMessage(l_ExceptionMsg);
				}

				l_infoArea.style.display = "inline";
				l_infoArea.lastElementChild.innerText = iMessage;
				if (iVisibleTime) {
					setTimeout(showOrHideInfo, iVisibleTime);
				}
			}
			else {
				l_infoArea.style.display = "none";
				l_infoArea.lastElementChild.innerText = "";
			}
		}
	</script>
</head>

<body class="cc-ltr">
	<span
		style="display: none;text-align: center;padding: 5px;border-bottom: 3px solid rgb(223, 51, 36);position: absolute;top: 5px;left: 5%;width: 90%;box-shadow: 0px 0px 5px 4px rgba(0,0,0,0.09);"
		id="InfoArea">
		<img src="../img/notification_error.svg" class="rtl-float-right" width="25px" height="25px" align="middle"
			style="margin-right:5px;">
		<span id="InfoText" style="position: relative;" class="rtl-float-right"></span>
	</span>
	<div class="col-xs-12 cc-frame-area">
		<h3 id="cc-doc-preview-loadmsg" data-translatable="true">Generating document...</h3>
		<iframe id="cc-doc-preview-frame" class="cc-frame"></iframe>
	</div>
</body>

</html>