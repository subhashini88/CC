<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="../../../../../thirdparty/bootstrap/css/bootstrap.min.css"></link>
    <link rel="stylesheet" href="../css/appscommon.css">
    <script src="../../../../../com/opentext/apps/utils/js/appscommon.js" type="text/javascript"></script>
    <script src="../../../../../thirdparty/jquery/jquery.js" type="text/javascript"></script>
    <script src="../../../../../html5/cordys.html5sdk.js" type="text/javascript"></script>
	<script src="../../../../../com/opentext/apps/utils/js/translationsUtil.js" type="text/javascript"></script>
    </link>
    <script type="text/javascript">
        var templateItemId;
        $(document).ready(function () {
            var parentElement = window.parent.$("#otActionActionDialogPanelContainer");
            parentElement.css('height', '300px');
            createToastDiv();
            var element = window.parent.$('.ui-dialog-buttonset');
            var okElement = element.children('.btn-ok');
            okElement.remove();
            templateItemId = getUrlParameterValue("instanceId", null, true);
            element.prepend('<button type="button" class="ui-widget ui-state-default ui-button-text-only' +
                ' btn btn-cancel btn-secondary btn-ok" role="button" aria-disabled="false" id="mycostumokbutton">' +
                '<span class="ui-button-text">OK</span></button>');

            element.children('#mycostumokbutton').click(function () {
                createNewVersion();
            });
            //disable scroll
            var parentElement = window.parent.$('#otActionActionDialogPanelContainer');
            parentElement.css('overflow', 'hidden');
			
			var i_locale = getlocale();
			var rtl_css = '../../../../../com/opentext/apps/utils/css/rtlappscommon.css';
            translateLabels("com/opentext/apps/commoncomponents/ContentLibrary/ContentLibrary", i_locale);
            if(document.getElementById("id_versionsummary")!=null)
            document.getElementById("id_versionsummary").placeholder = getTranslationMessage("Add template change summary");
			loadRTLIfRequired(i_locale,rtl_css);

        });

        function createNewVersion() {
            l_updateObj = updateUpdateParametersObject();
            l_updateObj.itemId = templateItemId;
            if (l_updateObj && templateItemId) {
                $.cordys.ajax(
                    {
                        method: "CreateNewVersionOfTemplate",
                        namespace: "http://schemas/OpenTextContentLibrary/16.5",
                        parameters: l_updateObj,

                    }).done(function (data) {
                        successToast(3000, "Version created");

                        var l_Id;
                        data["wstxns1:CreateGCTemplateResponse"]["wstxns2:GCTemplate"]["GCTemplate-id"].ItemId
                        if (data && data["wstxns1:CreateGCTemplateResponse"] &&
                            data["wstxns1:CreateGCTemplateResponse"]["wstxns2:GCTemplate"] &&
                            data["wstxns1:CreateGCTemplateResponse"]["wstxns2:GCTemplate"]["GCTemplate-id"]) {
                            l_Id = data["wstxns1:CreateGCTemplateResponse"]["wstxns2:GCTemplate"]["GCTemplate-id"].ItemId;
                        }
                        var urlToOpen = window.parent.location.href;

                        var redirectToNewVersion = function () {
                            if (urlToOpen && l_Id) {
                                urlToOpen = urlToOpen.replace(templateItemId, l_Id);
                                var win = window.parent.location.replace(urlToOpen);
                                win.focus();
                            }
                        }
                        setTimeout(redirectToNewVersion, 2000);



                    }).fail(function (error) {
                        if (error && error.responseJSON && error.responseJSON.faultstring) {
                            updateToastContent(error.responseJSON.faultstring.text, undefined);
                            errorToastToggle('show');
                        }
                    })
            }
        }

        function updateUpdateParametersObject() {
            l_updateVersionObj = updateVersionObject();

            return updateParametersObject = {
                versionSummary: l_updateVersionObj
            };
        }

        function updateVersionObject() {
            if (document.getElementById('id_versionsummary').value != "") {
                return document.getElementById('id_versionsummary').value;
            }
            else {
                return '';
            }
        }

    </script>


</head>

<body class="cc-ltr">
    <div class="container">
        <div class="form-group">
            <label class="label-with-blur" data-translatable="true">Change summary</label>
            <textarea data-bind="value:VersionSummary" class="apps-contentDiv enableDisable" id="id_versionsummary"
                style="height:230px; resize: none"></textarea>
        </div>
    </div>
</body>

</html>