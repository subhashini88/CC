<!DOCTYPE html>
<html>

<head>
    <title data-translatable="true">Add comments</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../../../../../thirdparty/bootstrap/css/bootstrap.min.css"></link>
    <link rel="stylesheet" href="../css/appscommon.css"></link>
    <script src="../../../../../thirdparty/jquery/jquery.js" type="text/javascript"></script>
    <script src="../../../../../html5/cordys.html5sdk.js" type="text/javascript"></script>
    <script src="../../../../../thirdparty/knockout/knockout.js" type="text/javascript"></script>
    <script src="../../../../../thirdparty/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../../../../../com/opentext/apps/utils/js/appscommon.js" type="text/javascript"></script>
	<script src="../../../../../com/opentext/apps/utils/js/translationsUtil.js" type="text/javascript"></script>
    <style>
        .comments-frame-area {
            height: 100vh;
            padding: 0;
            border-left: 1px solid #efefef;
        }

        .comments-frame {
            height: 99%;
            width: 100%;
            border: 0;
        }
		
		.docUploadWarning {
			font-family: 'Lato', 'Helvetica', 'Segoe UI', 'Tahoma', 'Arial', 'sans-serif';
			font-size: 1em;
			font-weight: 500;
			color: #333333;
		}
    </style>
    <script type="text/javascript">
        $.cordys.json.defaults.removeNamespacePrefix = true;
        var CommentsDataModel = function () {
            var self = this;
            self.comments = ko.observable();
            self.templateID = ko.observable();
        }
		
		var WarningFlagsModel = function(){
			var self = this;
			self.showDivNoDocWarning = ko.observable(false);
			self.showUploadDocWarning = ko.observable(false);
		}
        var commentsModel = new CommentsDataModel();
		var l_warningFlagsModel = new WarningFlagsModel();
		
        $(function () {
			ko.applyBindings(l_warningFlagsModel, document.getElementById("warningDivs"));
			var i_locale = getlocale();
			var rtl_css = '../../../../../com/opentext/apps/utils/css/rtlappscommon.css';
			translateLabels("com/opentext/apps/commoncomponents/ContentLibrary/ContentLibrary", i_locale);
			loadRTLIfRequired(i_locale,rtl_css);
            //$('[src*="addcomments_template.htm"]', window.parent.parent.document).parent().height("328px");
            //$('[src*="addcomments_template.htm"]', window.parent.parent.document).parent().parent().width("478px");
            $('[src*="addcomments_template.htm"]', window.parent.parent.document).height("250px");
            $('[src*="addcomments_template.htm"]', window.parent.parent.document).parent().css('overflow', 'hidden');
            cInstanceId = getUrlParameterValue("instanceId", null, true);
            getGCTemplateComments();
        });
        function getGCTemplateComments() {
            CommentsDataModel = $.cordys.ajax(
                {
                    namespace: "http://schemas/OpenTextContentLibrary/GCTemplate/operations",
                    method: "ReadGCTemplate",
                    parameters:
                    {
                        "GCTemplate-id":
                        {
                            "ItemId": cInstanceId
                        }
                    },
                    success: function (data) {
                        if (data) {
						if (data.GCTemplate.TemplateType == "Internal party document" || data.GCTemplate.TemplateType == "External party document") {
								$('#commentsDiv').attr('style', 'padding-top: 10px !important');;
								documentsContentServerExists(data.GCTemplate["GCTemplate-id"].Id);
							}
                            commentsModel.comments = data.GCTemplate.Comments;
                            commentsModel.templateID = data.GCTemplate["GCTemplate-id"].Id;
                            ko.applyBindings(commentsModel, document.getElementById("commentsDiv"));
                        }
                    }
                });
        }
		function documentsContentServerExists(templateID) {

			CommentsDataModel = $.cordys.ajax(
				{
					namespace: "http://schemas/OpenTextContentLibrary/16.5",
					method: "CheckDefaultDocTemplate",
					parameters:
					{
						"templateID":templateID
					},
					success: function (data) {
							if (data.docTemplateStatus.text == "true") {
								l_warningFlagsModel.showUploadDocWarning(true);
								$('[src*="addcomments_template.htm"]', window.parent.document).height("315px");
							} 
							else {
							l_warningFlagsModel.showDivNoDocWarning(true);
							$('[src*="addcomments_template.htm"]', window.parent.document).height("335px");
							}
					}
				});

		}
		
        function updateCommentsValue(val) {
            if (val != "") {
                return val;
            }
            else {
                return { '@xsi:nil': 'true' };
            }
        }

        function updateComments(value) {
            $.cordys.ajax(
                {
                    method: "UpdateGCTemplate",
                    namespace: "http://schemas/OpenTextContentLibrary/GCTemplate/operations",
                    parameters:
                    {
                        "GCTemplate-id": {
                            "Id": commentsModel.templateID
                        },
                        "GCTemplate-update": {
                            "@xmlns:xsi": "http://www.w3.org/2001/XMLSchema-instance",
                            "Comments": updateCommentsValue(value)
                        }
                    },
                }).done(function (data) {
                    
                }).fail(function (error) {
                    
                })
        }
        $(window).on("unload", function(e) {
            if (isIE()) {
                var ele = window.frameElement.ownerDocument.getElementsByTagName('iFrame');
                for (var i = 0; i < ele.length; i++) {
                    if ((ele[i].src).indexOf("template_sectionandclauses.htm") > -1) {
                        ele[i].src = ele[i].src;
                    }
                }
            } else {
                var source = $('[src*="template_sectionandclauses.htm"]', window.parent.document).attr('src');
                $('[src*="template_sectionandclauses.htm"]', window.parent.document).attr('src', source);
            }
        });
    </script>
</head>

<body class="cc-ltr">
	<div id="warningDivs">
		<!--ko if:showUploadDocWarning -->
		<div id="uploadWarningDiv" class="col-lg-12" style="overflow: auto;padding: 15px;display: block;">
			<span><img style="float: left; margin: 15px 5px 15px 0px;" src="../img/exclamationNew.png"></span>
			<div class="docUploadWarning" data-translatable="true">A template of the type Internal party document or External party document cannot be moved to the active state without a document. Upload at least one document to the Template documents folder under the Documents tab and ensure to update it in the Template details > Default document field.</div>
		</div>
		<!--/ko-->
		<!--ko if:showDivNoDocWarning-->
		<div id="warningDivNoDoc" class="col-lg-12" style="overflow: auto;padding: 15px;display: block;">
			<span><img style="float: left; margin: 30px 5px 25px 0px;" src="../img/exclamationNew.png"></span>
			<div class="docUploadWarning" data-translatable="true">No document uploaded</div>
			<div class="docUploadWarning" data-translatable="true">A template of the type Internal party document or External party document cannot be moved to the active state without a document. Upload at least one document to the Template documents folder under the Documents tab and ensure to update it in the Template details > Default document field.</div>
		</div>
		<!--/ko-->
	</div>
    <div id="commentsDiv" class="form-group cc-formgroup-no-float col-lg-12"
        style="padding-left: 50px; padding-right: 40px; padding-top: 30px;">
        <label class="label-no-bold" style="color: #757575;" data-translatable="true">Comments</label>
        <div>
            <textarea class="apps-contentDiv" data-bind="html:comments" onchange="updateComments(this.value)" rows="7"
                style="resize: none;"></textarea>
        </div>
    </div>
    </div>
</body>

</html>